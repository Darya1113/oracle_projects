WITH TAB AS(
SELECT 2 CH, 1 PAR, 2 COUNT FROM DUAL
UNION ALL
SELECT 5, 1, 2 FROM DUAL
UNION ALL
SELECT 3, 2, 1 FROM DUAL
UNION ALL
SELECT 4, 2, 2 FROM DUAL
UNION ALL
SELECT 4, 6, 2 FROM DUAL
UNION ALL
SELECT 6, 5, 3 FROM DUAL
UNION ALL
SELECT 4, 3, 2 FROM DUAL),
TAB2 AS
(SELECT CONNECT_BY_ROOT(PAR) || ' ' || CH AS PCH
        ,COUNT
        ,SYS_CONNECT_BY_PATH(PAR, '>') ||  '>' || CH AS FULL_PATH
 FROM TAB
 CONNECT BY PRIOR CH = PAR),
TAB3 AS
(SELECT DISTINCT PCH
        ,FULL_PATH
        ,REGEXP_SUBSTR(FULL_PATH, '[[:digit:]]+', 1, LEVEL) || ' ' || REGEXP_SUBSTR(FULL_PATH, '[[:digit:]]+', 1, LEVEL+1) INTERVAL
 FROM TAB2
 CONNECT BY LEVEL < LENGTH(FULL_PATH) - LENGTH(REPLACE(FULL_PATH, '>'))
 ORDER BY FULL_PATH),
TAB4 AS
(SELECT DISTINCT TAB3.PCH AS PATH
        ,TAB3.FULL_PATH
        ,TAB3.INTERVAL
        ,TAB2.COUNT
 FROM TAB3
 JOIN TAB2 
 ON TAB3.INTERVAL = TAB2.PCH
 ORDER BY FULL_PATH),
TAB5 AS
(SELECT  PATH
        ,FULL_PATH
        ,ROUND(EXP(SUM(LN(COUNT)))) PROIZV
 FROM TAB4
 GROUP BY PATH, FULL_PATH
 ORDER BY PATH),
TAB5A AS
(SELECT PATH
        ,COUNT(FULL_PATH) AS KOL
 FROM TAB5
 GROUP BY PATH
 ORDER BY PATH),
TAB6 AS
(SELECT PATH
        ,SUM(PROIZV)AS SUM
 FROM TAB5
 GROUP BY PATH
 ORDER BY PATH)
 
SELECT REGEXP_SUBSTR(TAB6.PATH, '[[:digit:]]', 1, 1) AS "Начальная вершина"
       ,REGEXP_SUBSTR(TAB6.PATH, '[[:digit:]]', 1, 2) AS "Конечная вершина"
       ,TAB5A.KOL AS "Количество путей"
       ,TAB6.SUM AS "Сумма произведений"
FROM TAB5A
JOIN TAB6
ON TAB5A.PATH = TAB6.PATH;
